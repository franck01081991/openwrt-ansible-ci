---
- name: Bootstrap OpenWrt nodes (no Python/SFTP required)
  hosts: openwrt
  gather_facts: false
  become: false
  tasks:
    - name: Ensure opkg database is updated
      ansible.builtin.raw: opkg update || true
      changed_when: false

    - name: Install python3 if missing
      ansible.builtin.raw: >
        opkg list-installed python3 >/dev/null 2>&1 ||
        opkg install python3
      changed_when: false

    - name: Install openssh-sftp-server (needed for Ansible copy/template)
      ansible.builtin.raw: >
        opkg list-installed openssh-sftp-server >/dev/null 2>&1 ||
        opkg install openssh-sftp-server
      changed_when: false

    - name: Verify python3 is present
      ansible.builtin.raw: command -v python3
      changed_when: false

    - name: Verify sftp-server is present
      ansible.builtin.raw: |
        command -v sftp-server ||
        test -x /usr/libexec/sftp-server ||
        test -x /usr/lib/sftp-server
      changed_when: false
